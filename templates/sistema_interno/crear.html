<!-- templates/equipos/crear.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Registrar Nuevo Equipo - Lab Metal Mec√°nica{% endblock %}

{% block extra_css %}
<style>
    /* Estilos espec√≠ficos del formulario - usando variables del base.html */
    .form-container {
        background: linear-gradient(135deg, var(--pure-white) 0%, var(--off-white) 100%);
        border-radius: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .form-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        padding: 2.5rem 2rem;
        position: relative;
        overflow: hidden;
    }

    .form-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .form-header h1 {
        font-size: 2rem;
        font-weight: 800;
        margin: 0;
        position: relative;
        z-index: 2;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.95;
        position: relative;
        z-index: 2;
        font-size: 1.1rem;
    }

    .form-section {
        background: linear-gradient(135deg, var(--pure-white) 0%, rgba(37, 99, 235, 0.02) 100%);
        border-radius: 1.25rem;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
        position: relative;
        backdrop-filter: blur(5px);
    }

    .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue), var(--success-green));
        border-radius: 1.25rem 1.25rem 0 0;
    }

    .form-section:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
        border-color: var(--primary-blue);
    }

    .form-section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--light-blue);
        position: relative;
    }

    .form-section-title::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
        border-radius: 1px;
    }

    .form-section-title i {
        font-size: 1.5rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, var(--light-blue), rgba(37, 99, 235, 0.1));
        border-radius: 0.75rem;
        color: var(--primary-blue);
    }

    /* Campos de formulario */
    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-label i {
        font-size: 1.1rem;
        color: var(--primary-blue);
        padding: 0.25rem;
        background: linear-gradient(135deg, var(--light-blue), rgba(37, 99, 235, 0.1));
        border-radius: 0.5rem;
    }

    .form-label .required {
        color: var(--danger-red);
        font-weight: 700;
        margin-left: 0.25rem;
    }

    /* Estilos de campos de entrada mejorados */
    .crear-form-control, 
    .crear-form-select {
        border: 2px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        font-size: 1rem;
        font-weight: 500;
        transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, var(--pure-white) 0%, rgba(248, 250, 252, 0.8) 100%);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .crear-form-control:hover, 
    .crear-form-select:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        transform: translateY(-1px);
    }

    .crear-form-control:focus, 
    .crear-form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 
            0 0 0 4px rgba(37, 99, 235, 0.2),
            0 8px 25px rgba(37, 99, 235, 0.2),
            inset 0 2px 4px rgba(0, 0, 0, 0.02);
        outline: none;
        transform: translateY(-2px);
        background: var(--pure-white);
    }

    /* Estados de validaci√≥n */
    .crear-form-control.is-invalid {
        border-color: var(--danger-red);
        background: linear-gradient(135deg, var(--pure-white) 0%, rgba(239, 68, 68, 0.05) 100%);
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        animation: shake 0.5s ease-in-out;
    }

    .crear-form-control.is-valid {
        border-color: var(--success-green);
        background: linear-gradient(135deg, var(--pure-white) 0%, rgba(16, 185, 129, 0.05) 100%);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Select espec√≠fico */
    .crear-form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23374151' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px 12px;
        padding-right: 3rem;
        cursor: pointer;
    }

    .crear-form-select:focus {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%232563eb' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    }

    /* Textarea espec√≠fico */
    textarea.crear-form-control {
        min-height: 120px;
        resize: vertical;
        line-height: 1.6;
    }

    /* Texto de ayuda */
    .form-text {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(248, 250, 252, 0.8) 100%);
        border-radius: 0.5rem;
        border-left: 3px solid var(--primary-blue);
    }

    .form-text i {
        color: var(--primary-blue);
        font-size: 1rem;
    }

    /* Campos UDB */
    .udb-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: linear-gradient(135deg, var(--light-blue), rgba(37, 99, 235, 0.1));
        border-radius: 0.75rem;
        border: 2px solid var(--primary-blue);
        position: relative;
    }

    .udb-part {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .udb-readonly {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        min-width: 70px;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }

    .udb-separator {
        font-weight: 900;
        font-size: 1.5rem;
        color: var(--primary-blue);
    }

    .udb-year {
        background: linear-gradient(135deg, var(--success-green), #059669);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        min-width: 60px;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }

    /* Validaci√≥n UDB */
    .udb-validation-indicator {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: white;
        z-index: 10;
    }

    .udb-validation-indicator.valid {
        background: var(--success-green);
        display: flex;
    }

    .udb-validation-indicator.invalid {
        background: var(--danger-red);
        display: flex;
    }

    /* Botones */
    .btn-industrial {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        border: none;
        color: white;
        padding: 1rem 2.5rem;
        border-radius: 0.75rem;
        font-weight: 700;
        font-size: 1.05rem;
        transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }

    .btn-industrial::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-industrial:hover::before {
        left: 100%;
    }

    .btn-industrial:hover {
        background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl);
        color: white;
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--pure-white), var(--off-white));
        border: 2px solid var(--border-color);
        color: var(--text-dark);
        padding: 1rem 2.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1.05rem;
        transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, var(--light-blue), var(--light-yellow));
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    /* Progreso sticky */
    .form-progress-sticky {
        position: sticky;
        top: 20px;
        z-index: 100;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(37, 99, 235, 0.1);
        box-shadow: 0 8px 32px rgba(37, 99, 235, 0.15);
        transition: all 0.3s ease;
    }

    .form-progress-sticky.scrolled {
        transform: scale(0.9);
        margin-bottom: 1rem;
        border-color: var(--primary-blue);
        box-shadow: 0 12px 40px rgba(37, 99, 235, 0.25);
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin-bottom: 1rem;
    }

    .progress-steps::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 10%;
        right: 10%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue), var(--success-green), var(--warning-orange));
        border-radius: 2px;
        z-index: 1;
        opacity: 0.3;
    }

    .progress-step {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 700;
        position: relative;
        z-index: 2;
        box-shadow: var(--shadow-md);
        transition: all var(--transition-speed) ease;
    }

    .progress-step.inactive {
        background: linear-gradient(135deg, var(--border-color), #d1d5db);
        color: var(--text-light);
        transform: scale(0.9);
    }

    .progress-step:not(.inactive) {
        animation: pulse 2s infinite;
    }

    .progress-step-mini {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 0.9rem;
    }

    @keyframes pulse {
        0%, 100% { box-shadow: var(--shadow-md); }
        50% { box-shadow: 0 0 0 8px rgba(37, 99, 235, 0.2), var(--shadow-lg); }
    }

    /* Vista previa de imagen */
    .image-preview {
        border: 3px dashed var(--border-color);
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        background: linear-gradient(135deg, var(--off-white), rgba(37, 99, 235, 0.05));
        transition: all var(--transition-speed) ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .image-preview:hover {
        border-color: var(--primary-blue);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), var(--light-blue));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .image-preview:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }

    .image-preview.dragover {
        border-color: var(--success-green) !important;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)) !important;
        border-style: solid !important;
    }

    .upload-placeholder {
        pointer-events: none;
        user-select: none;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.75rem;
        box-shadow: var(--shadow-md);
        transition: all var(--transition-speed) ease;
    }

    .image-preview:hover img {
        transform: scale(1.02);
        box-shadow: var(--shadow-lg);
    }

    /* Bot√≥n de eliminar imagen */
    .image-preview .btn-danger {
        transition: all 0.2s ease;
    }

    .image-preview .btn-danger:hover {
        transform: scale(1.1);
        background-color: var(--danger-red) !important;
    }

    /* Efecto de focus para accesibilidad */
    .image-preview:focus {
        outline: 2px solid var(--primary-blue);
        outline-offset: 2px;
    }

    /* Responsive para m√≥viles */
    @media (max-width: 768px) {
        .image-preview {
            min-height: 150px;
            padding: 1.5rem;
        }
        
        .image-preview img {
            max-height: 150px;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-header {
            padding: 2rem 1.5rem;
        }
        
        .form-header h1 {
            font-size: 1.75rem;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .crear-form-control, 
        .crear-form-select {
            padding: 0.875rem 1rem;
        }
        
        .btn-industrial,
        .btn-secondary {
            padding: 0.875rem 2rem;
            font-size: 1rem;
        }

        .udb-container {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .udb-part {
            justify-content: center;
        }

        .form-progress-sticky {
            top: 10px;
            padding: 1rem;
        }
        
        .form-progress-sticky.scrolled {
            transform: scale(0.85);
        }
        
        .progress-step-mini {
            width: 2rem;
            height: 2rem;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado principal -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="form-header">
                    <h1><i class="bi bi-plus-circle me-2"></i>Registrar Nuevo Equipo</h1>
                    <p>Complete la informaci√≥n para agregar un nuevo equipo al inventario del laboratorio</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progreso del formulario -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="form-progress form-progress-sticky" id="progressIndicator">
                <div class="progress-steps">
                    <div class="progress-step" id="step1">1</div>
                    <div class="progress-step inactive" id="step2">2</div>
                    <div class="progress-step inactive" id="step3">3</div>
                    <div class="progress-step inactive" id="step4">4</div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted fw-medium">Informaci√≥n B√°sica ‚Üí Especificaciones ‚Üí Ubicaci√≥n ‚Üí Confirmaci√≥n</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario principal -->
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="form-container dashboard-card">
                <div class="p-4">
                    <!-- Alerta de validaci√≥n -->
                    <div class="validation-alert" id="validationAlert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Por favor complete todos los campos requeridos</strong>
                        </div>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="equipoForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Secci√≥n 1: Informaci√≥n B√°sica -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-info-circle"></i>
                                Informaci√≥n B√°sica del Equipo
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-upc-scan"></i>
                                            C√≥digo Unidad de Disposici√≥n de Bienes <span class="required">*</span>
                                        </label>
                                        <div class="udb-container">
                                            <!-- Indicador de validaci√≥n personalizado -->
                                            <div class="udb-validation-indicator" id="udbValidation">
                                                <i class="bi bi-check"></i>
                                            </div>
                                            
                                            <div class="udb-part">
                                                <div class="udb-readonly">EMI</div>
                                                <span class="udb-separator">-</span>
                                            </div>
                                            <div class="udb-part">
                                                <select name="udb_unidad" id="id_udb_unidad" class="crear-form-select" style="max-width:120px;" required>
                                                    <option value="">Seleccione</option>
                                                    <option value="LPZ" {% if form.udb_unidad.value == 'LPZ' %}selected{% endif %}>LPZ</option>
                                                    <option value="SCZ" {% if form.udb_unidad.value == 'SCZ' %}selected{% endif %}>SCZ</option>
                                                    <option value="CBAA" {% if form.udb_unidad.value == 'CBAA' %}selected{% endif %}>CBAA</option>
                                                    <option value="RIB" {% if form.udb_unidad.value == 'RIB' %}selected{% endif %}>RIB</option>
                                                    <option value="TROP" {% if form.udb_unidad.value == 'TROP' %}selected{% endif %}>TROP</option>
                                                </select>
                                            </div>
                                            <div class="udb-part">
                                                <input type="text" name="udb_numero" id="id_udb_numero" class="crear-form-control"
                                                    placeholder="1-22386"
                                                    style="max-width:140px;"
                                                    value="{{ form.udb_numero.value|default:'' }}"
                                                    pattern="^\d-\d{5}$"
                                                    title="Debe tener el formato 1-12345 (un d√≠gito, guion, cinco d√≠gitos)"
                                                    required>
                                            </div>
                                            <div class="udb-part">
                                                <div class="udb-year>{{ current_year }}</div>
                                            </div>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Formato: <strong>EMI - [UNIDAD] [N√öMERO] [A√ëO]</strong>
                                            <br>
                                            <small class="text-muted">
                                                El n√∫mero debe tener el formato 1-12345 (cinco d√≠gitos despu√©s del guion)
                                            </small>
                                        </div>
                                        {% if form.udb_unidad.errors %}
                                            <div class="text-danger small mt-1">{{ form.udb_unidad.errors }}</div>
                                        {% endif %}
                                        {% if form.udb_numero.errors %}
                                            <div class="text-danger small mt-1">{{ form.udb_numero.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <!-- Campo UDB ocupa toda la fila -->
                                    <div class="col-md-12">
                                        <!-- UDB field aqu√≠ -->
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Los dem√°s campos en columnas normales -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_codigo_interno" class="form-label">
                                                <i class="bi bi-hash"></i>
                                                C√≥digo Interno <span class="required">*</span>
                                            </label>
                                            <input type="text" name="codigo_interno" id="id_codigo_interno" 
                                                   class="crear-form-control" 
                                                   placeholder="C√≥digo √∫nico para identificar el equipo"
                                                   value="{{ form.codigo_interno.value|default:'' }}" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                C√≥digo √∫nico para identificar el equipo
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_nombre" class="form-label">
                                                <i class="bi bi-tag"></i>
                                                Nombre del Equipo <span class="required">*</span>
                                            </label>
                                            <input type="text" name="nombre" id="id_nombre" class="crear-form-control"
                                                   placeholder="Nombre del equipo"
                                                   value="{{ form.nombre.value|default:'' }}" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Nombre descriptivo del equipo
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_modelo" class="form-label">
                                                <i class="bi bi-cpu"></i>
                                                Modelo <span class="required">*</span>
                                            </label>
                                            <input type="text" name="modelo" id="id_modelo" class="crear-form-control"
                                                   placeholder="Modelo del equipo"
                                                   value="{{ form.modelo.value|default:'' }}" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                Modelo espec√≠fico del fabricante
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_serie" class="form-label">
                                                <i class="bi bi-upc"></i>
                                                N√∫mero de Serie <span class="required">*</span>
                                            </label>
                                            <input type="text" name="serie" id="id_serie" class="crear-form-control"
                                                   placeholder="N√∫mero de serie"
                                                   value="{{ form.serie.value|default:'' }}" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i>
                                                N√∫mero de serie √∫nico del fabricante
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n 2: Especificaciones T√©cnicas -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-gear"></i>
                                Especificaciones T√©cnicas
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_fabricante" class="form-label">
                                            <i class="bi bi-building"></i>
                                            Fabricante <span class="required">*</span>
                                        </label>
                                        {{ form.fabricante }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Empresa fabricante del equipo
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_a√±o_fabricacion" class="form-label">
                                            <i class="bi bi-calendar"></i>
                                            A√±o de Fabricaci√≥n
                                        </label>
                                        {{ form.a√±o_fabricacion }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            A√±o de fabricaci√≥n del equipo
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_potencia" class="form-label">
                                            <i class="bi bi-lightning"></i>
                                            Potencia
                                        </label>
                                        {{ form.potencia }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Ejemplo: 5 kW, 10 HP, 220V
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_capacidad" class="form-label">
                                            <i class="bi bi-speedometer2"></i>
                                            Capacidad
                                        </label>
                                        {{ form.capacidad }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Ejemplo: 200 kg/h, 500 mm, 10 bar
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n 3: Ubicaci√≥n y Clasificaci√≥n -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-geo-alt"></i>
                                Ubicaci√≥n y Clasificaci√≥n
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_ubicacion_fisica" class="form-label">
                                            <i class="bi bi-pin-map"></i>
                                            Ubicaci√≥n F√≠sica <span class="required">*</span>
                                        </label>
                                        {{ form.ubicacion_fisica }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Ubicaci√≥n espec√≠fica dentro del laboratorio
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_seccion" class="form-label">
                                            <i class="bi bi-diagram-3"></i>
                                            Secci√≥n <span class="required">*</span>
                                        </label>
                                        {{ form.seccion }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Secci√≥n del laboratorio donde se encuentra
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_tipo_equipo" class="form-label">
                                            <i class="bi bi-collection"></i>
                                            Tipo de Equipo <span class="required">*</span>
                                        </label>
                                        {{ form.tipo_equipo }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Categor√≠a o tipo del equipo
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_estado" class="form-label">
                                            <i class="bi bi-activity"></i>
                                            Estado Actual <span class="required">*</span>
                                        </label>
                                        {{ form.estado }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Estado operacional del equipo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n 4: Informaci√≥n Adicional -->
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="bi bi-plus-circle"></i>
                                Informaci√≥n Adicional
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_responsable" class="form-label">
                                            <i class="bi bi-person-check"></i>
                                            Responsable <span class="required">*</span>
                                        </label>
                                        {{ form.responsable }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Persona responsable del equipo
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="id_foto" class="form-label">
                                            <i class="bi bi-camera"></i>
                                            Fotograf√≠a del Equipo
                                        </label>
                                        <div class="image-preview" id="imagePreview" role="button" tabindex="0">
                                            <div class="upload-placeholder">
                                                <i class="bi bi-cloud-upload display-4 text-muted"></i>
                                                <p class="mt-2 mb-0 fw-medium">Haga clic para seleccionar una imagen</p>
                                                <small class="text-muted">JPG, PNG, GIF - Max 5MB</small>
                                                <br>
                                                <small class="text-muted"><i class="bi bi-mouse"></i> O arrastre y suelte aqu√≠</small>
                                            </div>
                                        </div>
                                        <input type="file" name="foto" id="id_foto" class="d-none" accept="image/*" aria-label="Seleccionar fotograf√≠a del equipo">
                                        <div class="form-text mt-2">
                                            <i class="bi bi-info-circle"></i>
                                            Imagen del equipo para identificaci√≥n visual
                                        </div>
                                        {% if form.foto.errors %}
                                            <div class="text-danger small mt-1">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                {{ form.foto.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="id_observaciones" class="form-label">
                                            <i class="bi bi-chat-text"></i>
                                            Observaciones
                                        </label>
                                        {{ form.observaciones }}
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i>
                                            Informaci√≥n adicional, caracter√≠sticas especiales o notas importantes
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="d-flex justify-content-between align-items-center pt-4 border-top">
                            <a href="{% url 'equipos:equipo-lista' %}" class="btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn-industrial">
                                <i class="bi bi-check-circle"></i>
                                Registrar Equipo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('equipoForm');
    const validationAlert = document.getElementById('validationAlert');
    const imageInput = document.getElementById('id_foto');
    const imagePreview = document.getElementById('imagePreview');
    const udbValidation = document.getElementById('udbValidation');
    
    // Campos requeridos
    const requiredFields = [
        'id_udb_unidad', 'id_udb_numero', 'id_codigo_interno', 'id_nombre', 'id_modelo', 'id_serie', 
        'id_fabricante', 'id_ubicacion_fisica', 'id_seccion', 
        'id_tipo_equipo', 'id_estado', 'id_responsable'
    ];

    // Formateo autom√°tico para el campo UDB n√∫mero
    const udbNumeroField = document.getElementById('id_udb_numero');
    const udbUnidadField = document.getElementById('id_udb_unidad');
    
    if (udbNumeroField) {
        udbNumeroField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d-]/g, '');
            
            // Auto-formatear: agregar gui√≥n despu√©s del primer d√≠gito
            if (value.length === 1 && /^\d$/.test(value)) {
                value = value + '-';
            }
            
            // Limitar longitud
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            
            e.target.value = value;
            
            // Validar UDB completo
            validateUDB();
        });

        udbNumeroField.addEventListener('keypress', function(e) {
            // Permitir solo n√∫meros, gui√≥n, backspace, delete, tab, escape, enter
            if (![8, 9, 27, 13, 46, 45].includes(e.keyCode) && 
                (e.keyCode < 48 || e.keyCode > 57)) {
                e.preventDefault();
            }
        });
    }

    if (udbUnidadField) {
        udbUnidadField.addEventListener('change', function() {
            // Remover clases de validaci√≥n autom√°tica de Bootstrap
            this.classList.remove('is-valid', 'is-invalid');
            
            // Validar UDB completo
            setTimeout(() => {
                validateUDB();
            }, 50);
        });
    }

    // Funci√≥n para validar campos UDB sin mostrar iconos autom√°ticos
    function validateUDB() {
        const unidadValue = udbUnidadField ? udbUnidadField.value.trim() : '';
        const numeroValue = udbNumeroField ? udbNumeroField.value.trim() : '';
        const numeroPattern = /^\d-\d{5}$/;
        
        const isUnidadValid = unidadValue !== '';
        const isNumeroValid = numeroValue !== '' && numeroPattern.test(numeroValue);
        const isUDBComplete = isUnidadValid && isNumeroValid;
        
        // Remover todas las clases de validaci√≥n autom√°tica
        if (udbUnidadField) {
            udbUnidadField.classList.remove('is-valid', 'is-invalid');
        }
        if (udbNumeroField) {
            udbNumeroField.classList.remove('is-valid', 'is-invalid');
        }
        
        // Mostrar indicador personalizado
        if (isUDBComplete) {
            udbValidation.className = 'udb-validation-indicator valid';
            udbValidation.innerHTML = '<i class="bi bi-check"></i>';
        } else if (unidadValue || numeroValue) {
            udbValidation.className = 'udb-validation-indicator invalid';
            udbValidation.innerHTML = '<i class="bi bi-x"></i>';
        } else {
            udbValidation.className = 'udb-validation-indicator';
            udbValidation.innerHTML = '';
        }
    }

    // Validaci√≥n en tiempo real mejorada para otros campos
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.id.startsWith('id_udb_')) {
            field.addEventListener('blur', function() {
                validateField(this);
            });

            field.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        }
    });

    // Funci√≥n de validaci√≥n individual
    function validateField(field) {
        if (field.value.trim() === '') {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
        } else {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        }
    }

    // Validaci√≥n del formulario
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validar campos UDB por separado
        const unidadValue = udbUnidadField ? udbUnidadField.value.trim() : '';
        const numeroValue = udbNumeroField ? udbNumeroField.value.trim() : '';
        const numeroPattern = /^\d-\d{5}$/;
        
        if (!unidadValue || !numeroValue || !numeroPattern.test(numeroValue)) {
            isValid = false;
        }
        
        // Validar otros campos requeridos
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.id.startsWith('id_udb_') && !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault();
            validationAlert.classList.add('show');
            document.querySelector('.validation-alert').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            setTimeout(() => {
                validationAlert.classList.remove('show');
            }, 5000);
        }
    });

    // Preview de imagen CORREGIDO
    if (imageInput) {
        // Ocultar el input file original
        imageInput.style.display = 'none';
        imageInput.style.position = 'absolute';
        imageInput.style.left = '-9999px';
        
        // Evento click en el √°rea de preview
        imagePreview.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üñºÔ∏è Abriendo selector de archivos...');
            imageInput.click();
        });

        // Hacer que toda el √°rea sea clickeable
        imagePreview.style.cursor = 'pointer';
        
        // Evento change para mostrar la imagen seleccionada
        imageInput.addEventListener('change', function(e) {
            console.log('üìÅ Archivo seleccionado:', e.target.files[0]);
            
            const file = e.target.files[0];
            if (file) {
                // Validar tipo de archivo
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    alert('Por favor seleccione un archivo de imagen v√°lido (JPG, PNG, GIF)');
                    e.target.value = '';
                    return;
                }
                
                // Validar tama√±o (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. M√°ximo 5MB permitido.');
                    e.target.value = '';
                    return;
                }
                
                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.innerHTML = `
                        <div class="position-relative" style="display: inline-block;">
                            <img src="${e.target.result}" alt="Vista previa" class="img-fluid rounded" style="max-height: 200px; max-width: 100%;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute" 
                                    onclick="removeImage()" 
                                    style="top: 8px; right: 8px; border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; z-index: 10;"
                                    title="Eliminar imagen">
                                <i class="bi bi-x-lg" style="font-size: 14px;"></i>
                            </button>
                        </div>
                        <p class="mt-3 mb-0 small text-success fw-medium text-center">
                            <i class="bi bi-check-circle"></i> ${file.name}
                        </p>
                        <small class="text-muted d-block text-center">Haga clic para cambiar la imagen</small>
                    `;
                };
                reader.onerror = function() {
                    alert('Error al leer el archivo. Por favor intente nuevamente.');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Drag and drop functionality
        imagePreview.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = 'var(--primary-blue)';
            this.style.backgroundColor = 'rgba(37, 99, 235, 0.1)';
        });
        
        imagePreview.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = 'var(--border-color)';
            this.style.backgroundColor = '';
        });
        
        imagePreview.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = 'var(--border-color)';
            this.style.backgroundColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                imageInput.files = files;
                // Disparar evento change manualmente
                const event = new Event('change', { bubbles: true });
                imageInput.dispatchEvent(event);
            }
        });
    }

    // Funci√≥n global para remover imagen
    window.removeImage = function() {
        const imageInput = document.getElementById('id_foto');
        const imagePreview = document.getElementById('imagePreview');
        
        if (imageInput) {
            imageInput.value = '';
        }
        
        if (imagePreview) {
            imagePreview.innerHTML = `
                <div class="upload-placeholder">
                    <i class="bi bi-cloud-upload display-4 text-muted"></i>
                    <p class="mt-2 mb-0 fw-medium">Haga clic para seleccionar una imagen</p>
                    <small class="text-muted">JPG, PNG, GIF - Max 5MB</small>
                    <br>
                    <small class="text-muted"><i class="bi bi-mouse"></i> O arrastre y suelte aqu√≠</small>
                </div>
            `;
        }
    };

    console.log('‚úÖ Funcionalidad de imagen configurada correctamente');

    // Animaci√≥n de progreso mejorada
    let currentStep = 1;
    const steps = document.querySelectorAll('.progress-step');
    
    function updateProgress() {
        const filledFields = requiredFields.filter(fieldId => {
            const field = document.getElementById(fieldId);
            return field && field.value.trim() !== '';
        }).length;
        
        const progressPercent = (filledFields / requiredFields.length) * 100;
        const newStep = Math.ceil((progressPercent / 100) * 4);
        
        if (newStep !== currentStep) {
            steps.forEach((step, index) => {
                if (index < newStep) {
                    step.classList.remove('inactive');
                } else {
                    step.classList.add('inactive');
                }
            });
            currentStep = newStep;
        }
    }

    // Actualizar progreso cuando se completen campos
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateProgress);
            field.addEventListener('change', updateProgress);
        }
    });

    // Manejo del indicador de progreso sticky
    const progressIndicator = document.getElementById('progressIndicator');
    const progressSteps = document.querySelectorAll('.progress-step');

    // Detectar scroll para activar efectos del sticky
    let isScrolled = false;
    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        if (scrollTop > 200 && !isScrolled) {
            isScrolled = true;
            progressIndicator.classList.add('scrolled');
            // Hacer los pasos m√°s peque√±os cuando est√° sticky
            progressSteps.forEach(step => {
                step.classList.add('progress-step-mini');
            });
        } else if (scrollTop <= 200 && isScrolled) {
            isScrolled = false;
            progressIndicator.classList.remove('scrolled');
            // Restaurar tama√±o normal
            progressSteps.forEach(step => {
                step.classList.remove('progress-step-mini');
            });
        }
    });

    // Actualizar progreso basado en la secci√≥n visible
    const sections = document.querySelectorAll('.form-section');
    const progressStepElements = document.querySelectorAll('.progress-step');

    function updateProgressByScroll() {
        const scrollPosition = window.scrollY + window.innerHeight / 2;
        
        sections.forEach((section, index) => {
            const sectionTop = section.offsetTop;
            const sectionBottom = sectionTop + section.offsetHeight;
            
            if (scrollPosition >= sectionTop && scrollPosition <= sectionBottom) {
                // Activar el paso correspondiente
                progressStepElements.forEach((step, stepIndex) => {
                    if (stepIndex <= index) {
                        step.classList.remove('inactive');
                    } else {
                        step.classList.add('inactive');
                    }
                });
            }
        });
    }

    // Escuchar scroll para actualizar progreso autom√°ticamente
    window.addEventListener('scroll', debounce(updateProgressByScroll, 100));

    // Funci√≥n debounce para optimizar performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Inicializar validaci√≥n UDB
    validateUDB();
    
    // Inicializar progreso
    updateProgress();

    // Efecto de typing para placeholders
    const inputs = document.querySelectorAll('.form-control[placeholder]');
    inputs.forEach(input => {
        const originalPlaceholder = input.getAttribute('placeholder');
        input.addEventListener('focus', function() {
            this.setAttribute('placeholder', '');
        });
        
        input.addEventListener('blur', function() {
            if (!this.value) {
                this.setAttribute('placeholder', originalPlaceholder);
            }
        });
    });
});
</script>
{% endblock %}